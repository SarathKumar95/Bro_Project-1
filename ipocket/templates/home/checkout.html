{% extends 'home/base.html' %} 

{% block title %}Checkout{% endblock %}


{% block content %} 
{% load static %}


<style>
    input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type=number] {
  -moz-appearance: textfield;
}
  </style>



<div class="container">

    <div class="row mt-5">
      <div class="col-md-4 order-md-2 mb-4">
        <form action="" method="POST">        
          <h4 class="d-flex justify-content-between align-items-center mb-4-5">
          <span class="text-dark"><strong>Your cart</strong></span>
          <input type="hidden" value="{{cart}}" id="cart"> 
          <span class="badge badge-primary badge-pill">3</span>
        </h4>
        <ul class="list-group mb-3">
          {% for item in cart %}
          <input type="hidden" value="{{item.id}}" id="cartId">  
          <li class="list-group-item d-flex justify-content-between lh-condensed">
            <div>
                <input type="hidden" value="{{item.product.product_id}}" id="product_id">
                {% if item.product.series == None %}
                <h6 class="my-0">{{item.product.product_name}} {{item.product.generation}} </h6>
                {% elif item.product.generation == None %}
                <h6 class="my-0">{{item.product.product_name}} {{item.product.series}}</h6>
                {% elif item.product.generation == None and item.product.series == None %}
                <h6 class="my-0">{{item.product.product_name}}</h6>
                {% else %}
                <h6 class="my-0">{{item.product.product_name}} {{item.product.series}}</h6>
                {% endif %}
            </div>
            <span class="text-dark">{{item.product_qty}} x ₹{{item.product.price}}.00</span>
          </li>
         
         {% endfor %}
        </ul>
            <ul class="list-group list-group-flush">
                <li
                  class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                  <strong> Total : </strong><span>₹{{sub_total}}.00</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                  Shipping
                  {% if shipping == 0 %}
                  <span>Free</span>
                  {% else %}
                  <span>₹{{shipping}}.00</span>
                  {% endif %}
                </li>
                <li
                  class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                  <strong> Tax : </strong><span>{{tax}}%</span>
                </li>
                <li
                  class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                  <div>
                    <strong>Grand Total</strong>
                    <strong>
                      <p class="mb-0">(including VAT)</p>
                    </strong>
                  </div>
                  <span> ₹ <strong>{{grand_total}}</strong></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                    <div class="input-group">
                            <input type="text" class="form-control" name="coupon" placeholder="Promo code">
                            <div class="input-group-append">
                              <input type="submit" class="btn btn-primary btn-md my-0 ml-0" value="Redeem">
                            </div>
                      </div>
                </li>
              </ul>
      </div>
      <div class="col-md-8 order-md-1">
        <h4 class="mb-3"><strong>Billing address</strong></h4>
          {% for item in user_filt %}
          
            {% csrf_token %}
             <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="md-form md-outline my-2">
                <input type="text" id="firstName" name="fname" class="form-control" value="{{item.first_name}}" required>
                <label for="firstName">First name</label>
              </div>
              <div class="invalid-feedback">
                Valid first name is required.
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="md-form md-outline my-2">
                <input type="text" id="lastName" name="lname" class="form-control" value="{{item.last_name}}"  required>
                <label for="lastName">Last name</label>
              </div>
              <div class="invalid-feedback">
                Valid last name is required.
              </div>
            </div>
          </div>
  
          <div class="mb-3">
            <div class="md-form md-outline my-2">
              <input type="number" id="phnno" name="phno" class="form-control" value="{{item.mobile_number}}" required>
              <label for="phnno">Phone Number</label>
            </div>
            <div class="invalid-feedback">
              Your phone number is required.
            </div>
          </div>
  
          <div class="row">
            <div class="col-12 mb-3">
              <div class="md-form md-outline my-2">
                <input type="email" id="email" name="email" class="form-control" value="{{item.email}}">
                <label for="email">Email</label>
              </div>
              <div class="invalid-feedback">
                Please enter a valid email address for shipping updates.
              </div>
            </div>
  
            <div class="col-12 mb-3">
              <div class="md-form md-outline my-2">
                <input type="text" id="address" name="add" class="form-control" required>
                <label for="address">Address</label>
              </div>
              <div class="invalid-feedback">
                Please enter your shipping address.
              </div>
            </div>
  
          </div>
  
          <div class="row">
            <div class="col-md-4 mb-3">
              <select class="custom-select d-block w-100 mt-2" id="state" name="state" required>
                <option value="">State</option>
                <option>Kerala</option>
                <option>Karnataka</option>
                <option>Tamil Nadu</option>
              </select>
              <div class="invalid-feedback">
                Please provide a valid state.
              </div>
            </div>
            
            <div class="col-md-5 mb-3">
              <select class="custom-select d-block w-100 mt-2" id="city" name="city" required>
                <option value="">City</option>
                <option>Ernakulam</option>
                <option>Kottayam</option>
              </select>
              <div class="invalid-feedback">
                Please select a valid city.
              </div>
            </div>
            
          </div>
          <div class="row">
            <div class="col-md-3 mb-3">
              <div class="md-form md-outline mt-2 mb-0">
                <input type="text" id="zip" name="zip" class="form-control mb-0" required>
                <label for="zip">Pin Code</label>
              </div>
              <div class="invalid-feedback">
                Pin code required.
              </div>
            </div>
          </div>
          <hr class="mb-4">
          <div class="form-check pl-0">
            <input type="checkbox" class="form-check-input filled-in" id="same-address">
            <label class="form-check-label" for="same-address">Shipping address is the same as my billing address</label>
          </div>
          <div class="form-check pl-0">
            <input type="checkbox" class="form-check-input filled-in" id="save-info">
            <label class="form-check-label" for="save-info">Save this information for next time</label>
          </div>
  
          <hr class="mb-4">
  
          <h4 class="mb-3"><strong>Payment</strong></h4>
          <div class="d-block my-3"> 
            <div>
              <button onclick="placeOrder()" type="submit" name="paymentMethod" value="Cash On Delivery" class="btn btn-dark btn-sm">Cash On Delivery</button>
            </div>
            <div id="paypal-button-container" class="btn btn-sm"></div>


            
          </div>  
      
          <hr class="mb-4">
          <input type="submit" class="btn btn-warning btn-lg btn-block mb-4" value="Place Order">
        </form>
        {% endfor %}
      </div>
    </div>
  
    
  </div>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AaFTApw-aQlXqVUXWJR8JBZ87Tlc-ToRZuGoQyUJtXCSclWgrrTv8WkFt-V9YXD_xEqWx4XnOqU6ZCGe&currency=USD&intent=capture&enable-funding=venmo" data-sdk-integration-source="integrationbuilder"></script>

  <script>

    
    function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      var csrftoken = getCookie('csrftoken');
    
    
    function completeOrder(){

      var fname = document.querySelector("[name='fname']").value;
      var lname = document.querySelector("[name='lname']").value; 
      var email = document.querySelector("[name='email']").value; 
      var phone = document.querySelector("[name='phno']").value;
      var address = document.querySelector("[name = 'add' ]").value;
      var state = document.querySelector("[name = 'state' ]").value;
      var city = document.querySelector("[name = 'city' ]").value;
      var zip = document.querySelector("[name = 'zip' ]").value;
      var payment_mode = 'Paid by Paypal' ;

      console.log("Zip is", zip)

      var url = "{% url 'checkout' %}"
      var cartIn = document.getElementById('cart').value;
      
      console.log("Cart id is", cartIn)
      
      $.ajax({
        method : 'POST',
        url: url,
        data: {"fname" : fname,
        "lname" : lname,
        "email" : email,
        "phno" : phone,
        "add" : address,
        "city" : city,
        "state" : state,
        "zip" : zip,
        "paymentMethod":payment_mode,
         csrfmiddlewaretoken : csrftoken,
        },

        success: function (response) {
          alert("Order success!") 
        }
      });
    }

    
     const paypalButtonsComponent = paypal.Buttons({
              // optional styling for buttons
              // https://developer.paypal.com/docs/checkout/standard/customize/buttons-style-guide/
              style: {
                color: "black",
                shape: "pill",
                layout: "vertical"
              },

              // set up the transaction
              createOrder: (data, actions) => {
                  // pass in any options from the v2 orders create call:
                  // https://developer.paypal.com/api/orders/v2/#orders-create-request-body
                  const createOrderPayload = {
                      purchase_units: [
                          {
                              amount: {
                                  value: '10.00'
                              }
                          }
                      ]
                  };

                  return actions.order.create(createOrderPayload);
              },

              // finalize the transaction
              onApprove: function(data, actions){
                  return actions.order.capture().then(function(details){
                    completeOrder()
                    alert("Transaction Completed by " + details.payer.name.given_name + "!");
                  });
                  
              },

              // handle unrecoverable errors
              onError: (err) => {
                  alert('An error prevented the buyer from checking out with PayPal');
                  console.log(err);
              }
          });

          paypalButtonsComponent
              .render("#paypal-button-container")
              .catch((err) => {
                  console.error('PayPal Buttons failed to render');
              });

  </script>
  {% endblock %}